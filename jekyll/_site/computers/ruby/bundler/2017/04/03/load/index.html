
<!doctype html>














<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/assets/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/assets/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/assets/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="computers,ruby,bundler," />





  <link rel="alternate" href="/atom.xml" title="Julian's Notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico?v=5.1.1" />
















<meta name="description" content="initialize A quick look at load.setup shows us that the load method takes a small amount of time 0.0016739999991841614s. This means the bulk of the time is spent in setup. setup This method took about 0.6628200000268407s to run. As we can see, specs = groups.any? ? @definition.specs_for(groups) : requested_specs takes the most time (about 85% of the time). Let’s break that down a bit. I’ll just change the turnary to an if/else and see what that produces. As we can see, @definition.specs_for(groups) is not even called. All the time is spent in requested_specs. requested_specs It seems this delegates to definition. In definition, this is the result: Let’s look at specs_for specs_for specs.for(expand_dependencies(deps)) takes the most time, but is it the specs.for part, or the expand_dependencies part? It is the specs.for part: specs.for specs As we can see, about 3/4 of the time is spent making the specs, and 1/4 of the time processing with for. specs This line does quite a lot (resolve.materialize(Bundler.settings[:cache_all_platforms] ? dependencies : requested_dependencies)), so let’s split it up. As we can see, resolve and materialize take the most time. Materializing line num_calls time (s) resolve 73 0.05524000007426366 materialize 1 0.1665900000371039 materialize 374 0.15040999941993505 specs 374 0.13627100008307025 rubygems spec 296 0.03416500013554469 git specs 293 0.09133500000461936 search 596 0.012452999944798648 git-based specs We can see that we load 82 gemspecs - which takes the most time. Can we cache loading those gemspecs? They aren’t going to change in between loads. Globbing the filesystem also takes a chunk of time (Dir[&apos;#{expanded_path}/#{@glob}&apos;].sort_by {|p| -p.split(File::SEPARATOR).size }) - about 15% of 91ms to be exact. load_gemspec load_gemspec_uncached">
<meta name="keywords" content="computers, ruby, bundler">
<meta property="og:type" content="article">
<meta property="og:title" content="load">
<meta property="og:url" content="http://localhost:4000/computers/ruby/bundler/2017/04/03/load/">
<meta property="og:site_name" content="Julian's Notes">
<meta property="og:description" content="initialize A quick look at load.setup shows us that the load method takes a small amount of time 0.0016739999991841614s. This means the bulk of the time is spent in setup. setup This method took about 0.6628200000268407s to run. As we can see, specs = groups.any? ? @definition.specs_for(groups) : requested_specs takes the most time (about 85% of the time). Let’s break that down a bit. I’ll just change the turnary to an if/else and see what that produces. As we can see, @definition.specs_for(groups) is not even called. All the time is spent in requested_specs. requested_specs It seems this delegates to definition. In definition, this is the result: Let’s look at specs_for specs_for specs.for(expand_dependencies(deps)) takes the most time, but is it the specs.for part, or the expand_dependencies part? It is the specs.for part: specs.for specs As we can see, about 3/4 of the time is spent making the specs, and 1/4 of the time processing with for. specs This line does quite a lot (resolve.materialize(Bundler.settings[:cache_all_platforms] ? dependencies : requested_dependencies)), so let’s split it up. As we can see, resolve and materialize take the most time. Materializing line num_calls time (s) resolve 73 0.05524000007426366 materialize 1 0.1665900000371039 materialize 374 0.15040999941993505 specs 374 0.13627100008307025 rubygems spec 296 0.03416500013554469 git specs 293 0.09133500000461936 search 596 0.012452999944798648 git-based specs We can see that we load 82 gemspecs - which takes the most time. Can we cache loading those gemspecs? They aren’t going to change in between loads. Globbing the filesystem also takes a chunk of time (Dir[&apos;#{expanded_path}/#{@glob}&apos;].sort_by {|p| -p.split(File::SEPARATOR).size }) - about 15% of 91ms to be exact. load_gemspec load_gemspec_uncached">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/07e884f69afd901b12c0b51a28ef09f6.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/615f1c41da348502c193e68959692a37.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/58d1e97c0e200461c936baaa53e3dafe.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/787a9e70bd8caab794f9928d1c62ddd8.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/25a37703789441a3502a3f0cac608356.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/2e6f41664c612288598541f69ed6d7ce.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/1e0e32865dd876d5e30abcfb8a5720e9.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/d5e1e5092bb91951c29c59dc88ad2c72.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/a4abdd379f1207b63fab6d37ec66088a.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/005fba5b5ad80e50382313df2a1f4aaf.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/07b61084e06c0c400a0ba5b6a548fc23.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/28b3399c87fa8b4a55749e53e1e3e3b4.png">
<meta property="og:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/51fcc2cac0589579c867445fcd5b7dd8.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="load">
<meta name="twitter:description" content="initialize A quick look at load.setup shows us that the load method takes a small amount of time 0.0016739999991841614s. This means the bulk of the time is spent in setup. setup This method took about 0.6628200000268407s to run. As we can see, specs = groups.any? ? @definition.specs_for(groups) : requested_specs takes the most time (about 85% of the time). Let’s break that down a bit. I’ll just change the turnary to an if/else and see what that produces. As we can see, @definition.specs_for(groups) is not even called. All the time is spent in requested_specs. requested_specs It seems this delegates to definition. In definition, this is the result: Let’s look at specs_for specs_for specs.for(expand_dependencies(deps)) takes the most time, but is it the specs.for part, or the expand_dependencies part? It is the specs.for part: specs.for specs As we can see, about 3/4 of the time is spent making the specs, and 1/4 of the time processing with for. specs This line does quite a lot (resolve.materialize(Bundler.settings[:cache_all_platforms] ? dependencies : requested_dependencies)), so let’s split it up. As we can see, resolve and materialize take the most time. Materializing line num_calls time (s) resolve 73 0.05524000007426366 materialize 1 0.1665900000371039 materialize 374 0.15040999941993505 specs 374 0.13627100008307025 rubygems spec 296 0.03416500013554469 git specs 293 0.09133500000461936 search 596 0.012452999944798648 git-based specs We can see that we load 82 gemspecs - which takes the most time. Can we cache loading those gemspecs? They aren’t going to change in between loads. Globbing the filesystem also takes a chunk of time (Dir[&apos;#{expanded_path}/#{@glob}&apos;].sort_by {|p| -p.split(File::SEPARATOR).size }) - about 15% of 91ms to be exact. load_gemspec load_gemspec_uncached">
<meta name="twitter:image" content="https://jules2689.github.io/gitcdn/images/website/images/diagram/07e884f69afd901b12c0b51a28ef09f6.png">


<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://localhost:4000/"/>





  <title>load</title>
  
















</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Julian's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

<div id="posts" class="posts-expand">
  
  

  

  
  
  

  <article class="post post-type- " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/computers/ruby/bundler/2017/04/03/load/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Julian Nadeau">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="assets/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Julian's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
          
          
            load
          
        </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-03T16:25:24-04:00">
                2017-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/computers" itemprop="url" rel="index">
                    <span itemprop="name">computers</span>
                  </a>
                </span>

                
                
                  , 
                
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/ruby" itemprop="url" rel="index">
                    <span itemprop="name">ruby</span>
                  </a>
                </span>

                
                
                  , 
                
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/bundler" itemprop="url" rel="index">
                    <span itemprop="name">bundler</span>
                  </a>
                </span>

                
                
                  , 
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time</span>
                
                <span title="Reading time">
                  6
                </span>
              
            </div>
          

          
            
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="initialize">initialize</h2>

<p>A quick look at <code class="highlighter-rouge">load.setup</code> shows us that the <code class="highlighter-rouge">load</code> method takes a small amount of time <code class="highlighter-rouge">0.0016739999991841614s</code>. This means the bulk of the time is spent in <code class="highlighter-rouge">setup</code>.</p>

<h2 id="setup">setup</h2>

<p>This method took about <code class="highlighter-rouge">0.6628200000268407s</code> to run.</p>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/runtime.rb method: setup
   numberFormat  %.2f

   "groups.map!(&:to_sym)" :a1, 0.000, 0.151
   "clean_load_path" :a1, 0.151, 0.302
   "specs = groups.any? ? @definition.specs_for(groups) : requested_specs" :a1, 0.302, 85.592
   "SharedHelpers.set_bundle_environment" :a1, 85.592, 85.743
   "Bundler.rubygems.replace_entrypoints(specs)" :a1, 85.743, 90.408
   "load_paths = specs.map do |spec|" :a1, 90.408, 90.559
   "unless spec.loaded_from (run 375 times)" :a1, 90.559, 90.710
   "if (activated_spec = Bundler.rubygems.loaded_specs(spec.name)) && activated_spec.version != spec.version (run 375 times)" :a1, 90.710, 90.861
   "Bundler.rubygems.mark_loaded(spec) (run 375 times)" :a1, 90.861, 91.012
   "spec.load_paths.reject {|path| $LOAD_PATH.include?(path) } (run 804 times)" :a1, 91.012, 91.163
   "if insert_index = Bundler.rubygems.load_path_insert_index" :a1, 91.163, 91.314
   "$LOAD_PATH.insert(insert_index  *load_paths)" :a1, 91.314, 91.465
   "setup_manpath" :a1, 91.465, 93.292
   "lock(:preserve_unknown_sections => true)" :a1, 93.292, 99.849
   "self" :a1, 99.849, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/07e884f69afd901b12c0b51a28ef09f6.png" alt="diagram image" width="100%" /></p>

<p>As we can see, <code class="highlighter-rouge">specs = groups.any? ? @definition.specs_for(groups) : requested_specs</code> takes the most time (about 85% of the time).</p>

<p>Let’s break that down a bit. I’ll just change the turnary to an if/else and see what that produces.</p>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/runtime.rb method: setup
   numberFormat  %.2f

   "groups.map!(&:to_sym)" :a1, 0.000, 0.145
   "clean_load_path" :a1, 0.145, 0.290
   "specs = if groups.any?" :a1, 0.290, 0.435
   "requested_specs" :a1, 0.435, 82.871
   "SharedHelpers.set_bundle_environment" :a1, 82.871, 83.016
   "Bundler.rubygems.replace_entrypoints(specs)" :a1, 83.016, 88.346
   "load_paths = specs.map do |spec|" :a1, 88.346, 88.491
   "unless spec.loaded_from (run 375 times)" :a1, 88.491, 88.636
   "if (activated_spec = Bundler.rubygems.loaded_specs(spec.name)) && activated_spec.version != spec.version (run 375 times)" :a1, 88.636, 88.780
   "Bundler.rubygems.mark_loaded(spec) (run 375 times)" :a1, 88.780, 88.925
   "spec.load_paths.reject {|path| $LOAD_PATH.include?(path) } (run 804 times)" :a1, 88.925, 89.070
   "if insert_index = Bundler.rubygems.load_path_insert_index" :a1, 89.070, 89.215
   "$LOAD_PATH.insert(insert_index  *load_paths)" :a1, 89.215, 89.360
   "setup_manpath" :a1, 89.360, 91.577
   "lock(:preserve_unknown_sections => true)" :a1, 91.577, 99.855
   "self" :a1, 99.855, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/615f1c41da348502c193e68959692a37.png" alt="diagram image" width="100%" /></p>

<p>As we can see, <code class="highlighter-rouge">@definition.specs_for(groups)</code> is not even called. All the time is spent in <code class="highlighter-rouge">requested_specs</code>.</p>

<h2 id="requested_specs">requested_specs</h2>

<p>It seems this delegates to <code class="highlighter-rouge">definition</code>.</p>

<p>In <code class="highlighter-rouge">definition</code>, this is the result:</p>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: requested_specs
   numberFormat  %.2f

   "end" :a1, 0.000, 0.173
   "groups = requested_groups" :a1, 0.173, 0.345
   "groups.map!(&:to_sym)" :a1, 0.345, 0.518
   "specs_for(groups)" :a1, 0.518, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/58d1e97c0e200461c936baaa53e3dafe.png" alt="diagram image" width="100%" /></p>

<p>Let’s look at <code class="highlighter-rouge">specs_for</code></p>

<h2 id="specs_for">specs_for</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: specs_for
   numberFormat  %.2f

   "deps = dependencies.select {|d| (d.groups & groups).any? } (run 238 times)" :a1, 0.000, 0.152
   "deps.delete_if {|d| !d.should_include? } (run 238 times)" :a1, 0.152, 0.305
   "specs.for(expand_dependencies(deps))" :a1, 0.305, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/787a9e70bd8caab794f9928d1c62ddd8.png" alt="diagram image" width="100%" /></p>

<p><code class="highlighter-rouge">specs.for(expand_dependencies(deps))</code> takes the most time, but is it the <code class="highlighter-rouge">specs.for</code> part, or the <code class="highlighter-rouge">expand_dependencies</code> part?</p>

<p>It is the <code class="highlighter-rouge">specs.for</code> part:</p>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: specs_for
   numberFormat  %.2f

   "deps = dependencies.select {|d| (d.groups & groups).any? } (run 238 times)" :a1, 0.000, 0.167
   "deps.delete_if {|d| !d.should_include? } (run 238 times)" :a1, 0.167, 0.334
   "d = expand_dependencies(deps)" :a1, 0.334, 0.854
   "specs.for(d)" :a1, 0.854, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/25a37703789441a3502a3f0cac608356.png" alt="diagram image" width="100%" /></p>

<h2 id="specsfor">specs.for</h2>

<!---
```diagram
gantt
   title file: /development/opensource/bundler/lib/bundler/spec_set.rb method: for
   numberFormat  %.2f

   "handled = {} (run 4 times)" :a1, 0.000, 0.923
   "deps = dependencies.dup (run 4 times)" :a1, 0.923, 1.847
   "specs = [] (run 4 times)" :a1, 1.847, 2.770
   "skip += ['bundler'] (run 4 times)" :a1, 2.770, 3.693
   "loop do (run 4 times)" :a1, 3.693, 4.617
   "break unless dep = deps.shift (run 1834 times)" :a1, 4.617, 5.540
   "if spec = lookup['bundler'].first (run 4 times)" :a1, 5.540, 6.463
   "next if handled[dep] || skip.include?(dep.name) (run 1830 times)" :a1, 6.463, 7.387
   "handled[dep] = true (run 1821 times)" :a1, 7.387, 8.310
   "if spec = spec_for_dependency(dep  match_current_platform) (run 1821 times)" :a1, 8.310, 9.234
   "specs << spec (run 1821 times)" :a1, 9.234, 10.157
   "spec.dependencies.each do |d| (run 1821 times)" :a1, 10.157, 95.383
   "next if d.type == :development (run 28 times)" :a1, 95.383, 96.307
   "d = DepProxy.new(d  dep.__platform) unless match_current_platform (run 27 times)" :a1, 96.307, 97.230
   "deps << d (run 27 times)" :a1, 97.230, 98.153
   "specs << spec" :a1, 98.153, 99.077
   "check ? true : SpecSet.new(specs)" :a1, 99.077, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/2e6f41664c612288598541f69ed6d7ce.png" alt="diagram image" width="100%" /></p>

<h2 id="specs">specs</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: specs_for
   numberFormat  %.2f

   "deps = dependencies.select {|d| (d.groups & groups).any? } (run 238 times)" :a1, 0.000, 0.165
   "deps.delete_if {|d| !d.should_include? } (run 238 times)" :a1, 0.165, 0.330
   "d = expand_dependencies(deps)" :a1, 0.330, 0.836
   "s = specs" :a1, 0.836, 75.406
   "s.for(d)" :a1, 75.406, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/1e0e32865dd876d5e30abcfb8a5720e9.png" alt="diagram image" width="100%" /></p>

<p>As we can see, about 3/4 of the time is spent making the specs, and 1/4 of the time processing with <code class="highlighter-rouge">for</code>.</p>

<h2 id="specs-1">specs</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: specs
   numberFormat  %.2f

   "end" :a1, 0.000, 0.223
   "begin" :a1, 0.223, 0.445
   "specs = resolve.materialize(Bundler.settings[:cache_all_platforms] ? dependencies : requested_dependencies)" :a1, 0.445, 92.952
   "unless specs['bundler'].any?" :a1, 92.952, 95.996
   "local = Bundler.settings[:frozen] ? rubygems_index : index" :a1, 95.996, 99.286
   "bundler = local.search(Gem::Dependency.new('bundler'  VERSION)).last" :a1, 99.286, 99.555
   "specs['bundler'] = bundler if bundler" :a1, 99.555, 99.777
   "specs" :a1, 99.777, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/d5e1e5092bb91951c29c59dc88ad2c72.png" alt="diagram image" width="100%" /></p>

<p>This line does quite a lot (<code class="highlighter-rouge">resolve.materialize(Bundler.settings[:cache_all_platforms] ? dependencies : requested_dependencies)</code>), so let’s split it up.</p>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/definition.rb method: specs
   numberFormat  %.2f

   "end" :a1, 0.000, 0.222
   "begin" :a1, 0.222, 0.444
   "r = resolve" :a1, 0.444, 37.415
   "deps = if Bundler.settings[:cache_all_platforms]" :a1, 37.415, 37.637
   "requested_dependencies" :a1, 37.637, 37.859
   "specs = r.materialize(deps)" :a1, 37.859, 93.610
   "unless specs['bundler'].any?" :a1, 93.610, 96.213
   "local = Bundler.settings[:frozen] ? rubygems_index : index" :a1, 96.213, 99.286
   "bundler = local.search(Gem::Dependency.new('bundler'  VERSION)).last" :a1, 99.286, 99.556
   "specs['bundler'] = bundler if bundler" :a1, 99.556, 99.778
   "specs" :a1, 99.778, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/a4abdd379f1207b63fab6d37ec66088a.png" alt="diagram image" width="100%" /></p>

<p>As we can see, <code class="highlighter-rouge">resolve</code> and <code class="highlighter-rouge">materialize</code> take the most time.</p>

<hr />

<h2 id="materializing">Materializing</h2>

<table>
  <thead>
    <tr>
      <th>line</th>
      <th>num_calls</th>
      <th>time (s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>resolve</td>
      <td>73</td>
      <td>0.05524000007426366</td>
    </tr>
    <tr>
      <td>materialize</td>
      <td>1</td>
      <td>0.1665900000371039</td>
    </tr>
    <tr>
      <td><strong>materialize</strong></td>
      <td>374</td>
      <td>0.15040999941993505</td>
    </tr>
    <tr>
      <td>specs</td>
      <td>374</td>
      <td>0.13627100008307025</td>
    </tr>
    <tr>
      <td>rubygems spec</td>
      <td>296</td>
      <td>0.03416500013554469</td>
    </tr>
    <tr>
      <td>git specs</td>
      <td>293</td>
      <td>0.09133500000461936</td>
    </tr>
    <tr>
      <td>search</td>
      <td>596</td>
      <td>0.012452999944798648</td>
    </tr>
  </tbody>
</table>

<!---
```diagram
graph TD
  materialize -- 150ms -\-> __materialize__
  __materialize__ -- 136ms -\-> specs
  
  subgraph __materialize__
    specs -- 34ms -\-> rubygems_specs[RubyGems specs]
    specs -- 91ms -\-> git_specs[Git Specs]
    __materialize__ -- 12ms -\-> search
  end
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/005fba5b5ad80e50382313df2a1f4aaf.png" alt="diagram image" height="400" /></p>

<h2 id="git-based-specs">git-based specs</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler/source/path.rb method: load_spec_files
   numberFormat  %.2f

   "index = Index.new (run 71 times)" :a1, 0.000, 0.922
   "if File.directory?(expanded_path) (run 71 times)" :a1, 0.922, 8.775
   "Dir['#{expanded_path}/#{@glob}'].sort_by {|p| -p.split(File::SEPARATOR).size }.each do |file| (run 153 times)" :a1, 8.775, 23.952
   "next unless spec = Bundler.load_gemspec(file) (run 82 times)" :a1, 23.952, 94.468
   "spec.source = self (run 82 times)" :a1, 94.468, 95.390
   "Bundler.rubygems.set_installed_by_version(spec) (run 82 times)" :a1, 95.390, 96.312
   "validate_spec(spec) (run 82 times)" :a1, 96.312, 97.234
   "index << spec (run 82 times)" :a1, 97.234, 98.156
   "if index.empty? && @name && @version (run 71 times)" :a1, 98.156, 99.078
   "index" :a1, 99.078, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/07b61084e06c0c400a0ba5b6a548fc23.png" alt="diagram image" width="100%" /></p>

<p>We can see that we load 82 gemspecs - which takes the most time. Can we cache loading those gemspecs? They aren’t going to change in between loads.</p>

<p>Globbing the filesystem also takes a chunk of time (<code class="highlighter-rouge">Dir['#{expanded_path}/#{@glob}'].sort_by {|p| -p.split(File::SEPARATOR).size }</code>) - about 15% of 91ms to be exact.</p>

<h2 id="load_gemspec">load_gemspec</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler.rb method: load_gemspec
   numberFormat  %.2f

   "@gemspec_cache ||= {} (run 82 times)" :a1, 0.000, 1.374
   "key = File.expand_path(file) (run 82 times)" :a1, 1.374, 2.748
   "@gemspec_cache[key] ||= load_gemspec_uncached(file  validate) (run 82 times)" :a1, 2.748, 98.626
   "@gemspec_cache[key].dup if @gemspec_cache[key]" :a1, 98.626, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/28b3399c87fa8b4a55749e53e1e3e3b4.png" alt="diagram image" width="100%" /></p>

<h2 id="load_gemspec_uncached">load_gemspec_uncached</h2>

<!---
```diagram
gantt
   title file: /src/github.com/jules2689/bundler/lib/bundler.rb method: load_gemspec_uncached
   numberFormat  %.2f

   "path = Pathname.new(file) (run 82 times)" :a1, 0.000, 1.315
   "SharedHelpers.chdir(path.dirname.to_s) do (run 82 times)" :a1, 1.315, 2.631
   "contents = path.read (run 82 times)" :a1, 2.631, 3.946
   "spec = if contents[0..2] == '---' # YAML header (run 82 times)" :a1, 3.946, 5.262
   "eval_gemspec(path  contents) (run 82 times)" :a1, 5.262, 94.738
   "return unless spec (run 82 times)" :a1, 94.738, 96.054
   "spec.loaded_from = path.expand_path.to_s (run 82 times)" :a1, 96.054, 97.369
   "Bundler.rubygems.validate(spec) if validate (run 82 times)" :a1, 97.369, 98.685
   "spec" :a1, 98.685, 100.000
```
--->
<p><img src="https://jules2689.github.io/gitcdn/images/website/images/diagram/51fcc2cac0589579c867445fcd5b7dd8.png" alt="diagram image" width="100%" /></p>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            
            <a href="/tag/#/computers" rel="tag"># computers</a>
          
            
            <a href="/tag/#/ruby" rel="tag"># ruby</a>
          
            
            <a href="/tag/#/bundler" rel="tag"># bundler</a>
          
        </div>
      

      
      
      
      
      

      
      
        <div class="post-nav" id="post-nav-id">
          <div class="post-nav-next post-nav-item">
            
              <a href="/computers/ruby/bundler/2017/04/05/ruby_gems/" rel="next" title="RubyGems">
                <i class="fa fa-chevron-left"></i> RubyGems
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/finance/2017/04/02/macd/" rel="prev" title="Moving Average Convergence Divergence - MACD">
                Moving Average Convergence Divergence - MACD <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
      

      
    </footer>
  </article>

  <div class="post-spread">
    
  </div>
</div>


          </div>
          


          

        </div>
        
          

  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        
        
        




      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/assets/images/avatar.gif"
               alt="Julian Nadeau" />
          <p class="site-author-name" itemprop="name">Julian Nadeau</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
        
        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            





            
              <div class="post-toc-content">
    <ol class=nav>
      <li class="nav-item nav-level-2"> <a class="nav-link" href="#initialize"> <span class="nav-number">1</span> <span class="nav-text">initialize</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#setup"> <span class="nav-number">2</span> <span class="nav-text">setup</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#requested_specs"> <span class="nav-number">3</span> <span class="nav-text">requested_specs</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#specs_for"> <span class="nav-number">4</span> <span class="nav-text">specs_for</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#specsfor"> <span class="nav-number">5</span> <span class="nav-text">specs.for</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#specs"> <span class="nav-number">6</span> <span class="nav-text">specs</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#specs-1"> <span class="nav-number">7</span> <span class="nav-text">specs</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#materializing"> <span class="nav-number">8</span> <span class="nav-text">Materializing</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#git-based-specs"> <span class="nav-number">9</span> <span class="nav-text">git-based specs</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#load_gemspec"> <span class="nav-number">10</span> <span class="nav-text">load_gemspec</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> </li></ol> </li></ol> </li></ol> </li></ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#load_gemspec_uncached"> <span class="nav-number">11</span> <span class="nav-text">load_gemspec_uncached</span> </a> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child"> <ol class="nav-child">
    </ol>
  </div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>

        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Julian Nadeau</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://jekyllrb.com">Jekyll</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/simpleyyt/jekyll-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





















  
   
  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/assets/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/assets/js/src/motion.js?v=5.1.1"></script>



  
  

  <script type="text/javascript" src="/assets/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/assets/js/src/post-details.js?v=5.1.1"></script>


  


  <script type="text/javascript" src="/assets/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  




  

    

  





  






  

  

  
  


  

  

  

</body>
</html>

